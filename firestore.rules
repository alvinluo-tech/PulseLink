rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========== 通用辅助函数 ==========
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========== 用户文档 ==========
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // ========== 测试日志（仅开发用）==========
    match /test_logs/{document=**} {
      allow read, write: if true;
    }
    
    // ========== 方案C：新架构集合 ==========
    
    // 老人档案（简化版）
    match /senior_profiles/{profileId} {
      function isCreator() {
        return isAuthenticated() && resource.data.creatorId == request.auth.uid;
      }
      
      function isSeniorUser() {
        return isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      function hasActiveRelation() {
        let relationId = request.auth.uid + '_' + profileId;
        return exists(/databases/$(database)/documents/caregiver_relations/$(relationId))
            && get(/databases/$(database)/documents/caregiver_relations/$(relationId)).data.status == 'active';
      }
      
      // 创建：已认证用户可创建，creatorId 必须是自己
      allow create: if isAuthenticated()
                    && request.resource.data.creatorId == request.auth.uid;
      
      // 读取：任何已认证用户都可以读取（通过关系和权限在应用层控制）
      // 这样可以支持查询，实际权限通过 caregiver_relations 控制
      allow read: if isAuthenticated();
      
      // 更新：老人自己或创建者
      allow update: if isAuthenticated() && (
        (resource != null && isSeniorUser()) 
        || (resource != null && isCreator())
      );
      
      // 删除：仅创建者
      allow delete: if isAuthenticated() && resource != null && isCreator();
    }
    
    // 老人密码（单独存储）
    match /senior_passwords/{profileId} {
      function isProfileCreator() {
        return isAuthenticated()
            && exists(/databases/$(database)/documents/senior_profiles/$(profileId))
            && get(/databases/$(database)/documents/senior_profiles/$(profileId)).data.creatorId == request.auth.uid;
      }
      
      function isProfileUser() {
        return isAuthenticated()
            && exists(/databases/$(database)/documents/senior_profiles/$(profileId))
            && get(/databases/$(database)/documents/senior_profiles/$(profileId)).data.userId == request.auth.uid;
      }
      
      // 创建：创建者
      allow create: if isProfileCreator();
      
      // 读取：创建者或老人自己
      allow read: if isProfileCreator() || isProfileUser();
      
      // 更新：创建者或老人自己
      allow update: if isProfileCreator() || isProfileUser();
      
      // 删除：创建者
      allow delete: if isProfileCreator();
    }
    
    // 护理者关系
    match /caregiver_relations/{relationId} {
      function isCaregiver() {
        return isAuthenticated() && resource.data.caregiverId == request.auth.uid;
      }
      
      function isSeniorOwner() {
        let profileId = resource.data.seniorId;
        let profile = get(/databases/$(database)/documents/senior_profiles/$(profileId));
        return isAuthenticated() 
            && (profile.data.userId == request.auth.uid || profile.data.creatorId == request.auth.uid);
      }
      
      function canApprove() {
        // 老人本人或创建者可以审批
        return isSeniorOwner()
            // 或者有审批权限的护理者
            || (isAuthenticated() && resource.data.canApproveRequests == true);
      }
      
      function isProfileCreator() {
        let profileId = request.resource.data.seniorId;
        return exists(/databases/$(database)/documents/senior_profiles/$(profileId))
            && get(/databases/$(database)/documents/senior_profiles/$(profileId)).data.creatorId == request.auth.uid;
      }
      
      // 根据 relationId 格式判断是否为关系的参与者
      // relationId 格式: {caregiverId}_{seniorId}
      function isRelationParticipant() {
        // relationId 以当前用户 ID 开头，说明是护理者
        return relationId.matches(request.auth.uid + '_.*');
      }
      
      // 创建：护理者可创建关系请求（pending），或者是老人的创建者可以直接创建 active 关系
      allow create: if isAuthenticated()
                    && request.resource.data.caregiverId == request.auth.uid
                    && (request.resource.data.status == 'pending' 
                        || (request.resource.data.status == 'active' && isProfileCreator()));
      
      // 读取：护理者（relationId以用户ID开头）或老人相关方（如果文档存在）
      allow read: if isAuthenticated() && (
        isRelationParticipant() 
        || (resource != null && (isCaregiver() || isSeniorOwner()))
      );
      
      // 更新：有审批权的人可以更新状态，护理者可以删除自己的请求
      allow update: if canApprove();
      
      // 删除：护理者或老人相关方
      allow delete: if isCaregiver() || isSeniorOwner();
    }
    
    // 健康记录
    match /health_records/{recordId} {
      function isSeniorUser(seniorId) {
        // 检查当前用户是否是这条记录对应的老人
        // 通过 senior_profiles 反查，看当前用户是否是该档案的 userId
        return isAuthenticated() 
            && exists(/databases/$(database)/documents/senior_profiles/$(seniorId))
            && get(/databases/$(database)/documents/senior_profiles/$(seniorId)).data.userId != null
            && get(/databases/$(database)/documents/senior_profiles/$(seniorId)).data.userId == request.auth.uid;
      }
      
      function isProfileCreator(seniorId) {
        // 检查当前用户是否是老人档案的创建者
        return isAuthenticated()
            && exists(/databases/$(database)/documents/senior_profiles/$(seniorId))
            && get(/databases/$(database)/documents/senior_profiles/$(seniorId)).data.creatorId == request.auth.uid;
      }
      
      function hasHealthDataPermission(seniorId) {
        // 检查护理者是否有查看健康数据的权限
        let relationId = request.auth.uid + '_' + seniorId;
        return isAuthenticated()
            && exists(/databases/$(database)/documents/caregiver_relations/$(relationId))
            && get(/databases/$(database)/documents/caregiver_relations/$(relationId)).data.status == 'active'
            && get(/databases/$(database)/documents/caregiver_relations/$(relationId)).data.canViewHealthData == true;
      }
      
      function hasEditHealthPermission(seniorId) {
        let relationId = request.auth.uid + '_' + seniorId;
        return isAuthenticated()
            && exists(/databases/$(database)/documents/caregiver_relations/$(relationId))
            && get(/databases/$(database)/documents/caregiver_relations/$(relationId)).data.status == 'active'
            && get(/databases/$(database)/documents/caregiver_relations/$(relationId)).data.canEditHealthData == true;
      }
      
      // 创建：认证用户可以创建自己或有权限的老人的记录
      allow create: if isAuthenticated() && (
        isSeniorUser(request.resource.data.seniorId)  // 老人为自己创建
        || isProfileCreator(request.resource.data.seniorId)  // 档案创建者创建
        || hasEditHealthPermission(request.resource.data.seniorId)  // 有编辑权限的护理者创建
      );
      
      // 读取：查询时允许所有认证用户，单个文档读取时验证权限
      allow read: if isAuthenticated() && (
        resource == null  // 查询时允许
        || isSeniorUser(resource.data.seniorId)  // 老人本人
        || isProfileCreator(resource.data.seniorId)  // 档案创建者
        || hasHealthDataPermission(resource.data.seniorId)  // 有权限的护理者
      );
      
      // 更新：老人本人、档案创建者、或有编辑权限的护理者
      allow update: if isAuthenticated() && (
        isSeniorUser(resource.data.seniorId) 
        || isProfileCreator(resource.data.seniorId) 
        || hasEditHealthPermission(resource.data.seniorId)
      );
      
      // 删除：老人本人或档案创建者
      allow delete: if isAuthenticated() && resource != null && (
        isSeniorUser(resource.data.seniorId) 
        || isProfileCreator(resource.data.seniorId)
      );
    }
    
    // ========== 其他集合 ==========
    
    // 提醒数据
    match /reminders/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // 聊天记录
    match /chat_history/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
  }
}
