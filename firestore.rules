rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========== 通用辅助函数 ==========
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========== 用户文档 ==========
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // ========== 测试日志（仅开发用）==========
    match /test_logs/{document=**} {
      allow read, write: if true;
    }
    
    // ========== 方案C：新架构集合 ==========
    
    // 老人档案（简化版）
    match /senior_profiles/{profileId} {
      function isCreator() {
        return isAuthenticated() && resource.data.creatorId == request.auth.uid;
      }
      
      function isSeniorUser() {
        return isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      function hasActiveRelation() {
        let relationId = request.auth.uid + '_' + profileId;
        return exists(/databases/$(database)/documents/caregiver_relations/$(relationId))
            && get(/databases/$(database)/documents/caregiver_relations/$(relationId)).data.status == 'active';
      }
      
      // 创建：已认证用户可创建，creatorId 必须是自己
      allow create: if isAuthenticated()
                    && request.resource.data.creatorId == request.auth.uid;
      
      // 读取：老人自己、创建者、有活跃关系的护理者
      allow read: if isAuthenticated() 
                  && (isSeniorUser() || isCreator() || hasActiveRelation());
      
      // 更新：老人自己或创建者
      allow update: if isSeniorUser() || isCreator();
      
      // 删除：仅创建者
      allow delete: if isCreator();
    }
    
    // 老人密码（单独存储）
    match /senior_passwords/{profileId} {
      function isProfileCreator() {
        return isAuthenticated()
            && exists(/databases/$(database)/documents/senior_profiles/$(profileId))
            && get(/databases/$(database)/documents/senior_profiles/$(profileId)).data.creatorId == request.auth.uid;
      }
      
      function isProfileUser() {
        return isAuthenticated()
            && exists(/databases/$(database)/documents/senior_profiles/$(profileId))
            && get(/databases/$(database)/documents/senior_profiles/$(profileId)).data.userId == request.auth.uid;
      }
      
      // 创建：创建者
      allow create: if isProfileCreator();
      
      // 读取：创建者或老人自己
      allow read: if isProfileCreator() || isProfileUser();
      
      // 更新：创建者或老人自己
      allow update: if isProfileCreator() || isProfileUser();
      
      // 删除：创建者
      allow delete: if isProfileCreator();
    }
    
    // 护理者关系
    match /caregiver_relations/{relationId} {
      function isCaregiver() {
        return isAuthenticated() && resource.data.caregiverId == request.auth.uid;
      }
      
      function isSeniorOwner() {
        let profileId = resource.data.seniorProfileId;
        let profile = get(/databases/$(database)/documents/senior_profiles/$(profileId));
        return isAuthenticated() 
            && (profile.data.userId == request.auth.uid || profile.data.creatorId == request.auth.uid);
      }
      
      function canApprove() {
        // 老人本人或创建者可以审批
        return isSeniorOwner()
            // 或者有审批权限的护理者
            || (isAuthenticated() && resource.data.canApproveRequests == true);
      }
      
      // 创建：护理者可创建关系请求
      allow create: if isAuthenticated()
                    && request.resource.data.caregiverId == request.auth.uid
                    && request.resource.data.status == 'pending';
      
      // 读取：护理者或老人相关方
      allow read: if isCaregiver() || isSeniorOwner();
      
      // 更新：有审批权的人可以更新状态，护理者可以删除自己的请求
      allow update: if canApprove();
      
      // 删除：护理者或老人相关方
      allow delete: if isCaregiver() || isSeniorOwner();
    }
    
    // 健康记录
    match /health_records/{recordId} {
      function getSeniorProfile() {
        return get(/databases/$(database)/documents/senior_profiles/$(resource.data.seniorProfileId));
      }
      
      function isSeniorOwner() {
        let profile = getSeniorProfile();
        return isAuthenticated() 
            && (profile.data.userId == request.auth.uid || profile.data.creatorId == request.auth.uid);
      }
      
      function hasHealthDataPermission() {
        let relationId = request.auth.uid + '_' + resource.data.seniorProfileId;
        return exists(/databases/$(database)/documents/caregiver_relations/$(relationId))
            && get(/databases/$(database)/documents/caregiver_relations/$(relationId)).data.status == 'active'
            && get(/databases/$(database)/documents/caregiver_relations/$(relationId)).data.canViewHealthData == true;
      }
      
      function hasEditHealthPermission() {
        let relationId = request.auth.uid + '_' + resource.data.seniorProfileId;
        return exists(/databases/$(database)/documents/caregiver_relations/$(relationId))
            && get(/databases/$(database)/documents/caregiver_relations/$(relationId)).data.status == 'active'
            && get(/databases/$(database)/documents/caregiver_relations/$(relationId)).data.canEditHealthData == true;
      }
      
      // 创建：老人或有编辑权限的护理者
      allow create: if isAuthenticated();  // 简化：先允许所有认证用户，后续细化
      
      // 读取：老人或有查看权限的护理者
      allow read: if isSeniorOwner() || hasHealthDataPermission();
      
      // 更新：老人或有编辑权限的护理者
      allow update: if isSeniorOwner() || hasEditHealthPermission();
      
      // 删除：老人或创建者
      allow delete: if isSeniorOwner();
    }
    
    // ========== 旧架构集合（保持兼容）==========
    
    // 健康数据（旧）
    match /health_data/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
      allow read: if isAuthenticated() 
                  && exists(/databases/$(database)/documents/seniors/$(getSeniorIdByUid(userId)))
                  && request.auth.uid in get(/databases/$(database)/documents/seniors/$(getSeniorIdByUid(userId))).data.caregiverIds;
    }
    
    function getSeniorIdByUid(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.seniorId;
    }
    
    // 提醒数据
    match /reminders/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // 聊天记录
    match /chat_history/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // 老人账户数据（旧）- 保持兼容
    match /seniors/{seniorId} {
      function isCreator() {
        return isAuthenticated() && resource.data.creatorId == request.auth.uid;
      }

      function isCaregiverBound() {
        return isAuthenticated() && (request.auth.uid in resource.data.caregiverIds);
      }

      function isSeniorSelf() {
        return isAuthenticated() 
               && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('seniorId', null) == seniorId;
      }

      function hasPermissionToUpdate() {
        let relationship = resource.data.caregiverRelationships[request.auth.uid];
        let changedKeys = request.resource.data.diff(resource.data).changedKeys();
        return (relationship.permissions.canEditReminders && changedKeys.hasOnly(['reminders']))
            || (relationship.permissions.canViewHealthData && changedKeys.hasOnly(['healthHistory']));
      }

      allow create: if isAuthenticated()
                    && (
                      (request.resource.data.creatorId == request.auth.uid
                       && (request.auth.uid in request.resource.data.caregiverIds)
                       && request.resource.data.caregiverIds.size() >= 1
                       && request.resource.data.registrationType == 'CAREGIVER_CREATED')
                      ||
                      (request.resource.data.registrationType == 'SELF_REGISTERED'
                       && request.resource.data.creatorId == request.auth.uid
                       && request.resource.data.caregiverIds.size() == 0)
                    )
                    && request.resource.data.keys().hasOnly([
                      'id','name','age','gender','avatarType','healthHistory','caregiverIds','caregiverRelationships','creatorId','createdAt','password','registrationType'
                    ]);

      allow read: if isAuthenticated();

      allow delete: if isCreator();

      allow update: if isSeniorSelf()
                    || (isCreator() && !request.resource.data.diff(resource.data).changedKeys().hasAny(['caregiverRelationships']))
                    || (isAuthenticated()
                        && !(request.auth.uid in resource.data.caregiverIds)
                        && !(request.auth.uid in request.resource.data.caregiverIds)
                        && request.resource.data.creatorId == resource.data.creatorId
                        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['caregiverRelationships'])
                        && request.resource.data.caregiverIds == resource.data.caregiverIds)
                    || (isCaregiverBound() && hasPermissionToUpdate());
    }
    
    // Link Requests（旧）- 保持兼容
    match /linkRequests/{requestId} {
      function isRequester() {
        return isAuthenticated() && resource.data.requesterId == request.auth.uid;
      }
      
      function isSeniorOwner() {
        let senior = get(/databases/$(database)/documents/seniors/$(resource.data.seniorId));
        return isAuthenticated()
               && (
                 (senior.data.registrationType == 'SELF_REGISTERED' && senior.data.creatorId == request.auth.uid)
                 || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('seniorId', null) == resource.data.seniorId)
               );
      }
      
      function canApprove() {
        let senior = get(/databases/$(database)/documents/seniors/$(resource.data.seniorId));
        return isSeniorOwner() 
            || (isAuthenticated() && request.auth.uid in senior.data.get('linkRequestApprovers', []));
      }
      
      allow create: if isAuthenticated()
                    && request.resource.data.requesterId == request.auth.uid
                    && request.resource.data.status == 'pending';
      
      allow read: if isRequester() || canApprove();
      
      allow update: if canApprove()
                    && request.resource.data.requesterId == resource.data.requesterId
                    && request.resource.data.seniorId == resource.data.seniorId
                    && request.resource.data.creatorId == resource.data.creatorId;
      
      allow delete: if isRequester() || canApprove();
    }
  }
}
