<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PulseLink æ— æ„Ÿç™»å½•æµç¨‹å›¾</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
        }
        .flow-diagram {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 40px;
        }
        .step {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            position: relative;
        }
        .step.start {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .step.check {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .step.auth {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .step.senior {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .step.caregiver {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }
        .step.welcome {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        .arrow {
            text-align: center;
            color: #667eea;
            font-size: 24px;
            font-weight: bold;
        }
        .branch-container {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        .branch {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .branch-label {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            color: #555;
        }
        .scenario {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .scenario h3 {
            color: #667eea;
            margin-top: 0;
        }
        .scenario-flow {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 20px 0;
        }
        .keyword {
            color: #66d9ef;
        }
        .function {
            color: #a6e22e;
        }
        .string {
            color: #e6db74;
        }
        .comment {
            color: #75715e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” PulseLink æ— æ„Ÿç™»å½•æµç¨‹å›¾</h1>
        
        <h2>ğŸ“Š ä¸»æµç¨‹å›¾</h2>
        <div class="flow-diagram">
            <div class="step start">App å¯åŠ¨</div>
            <div class="arrow">â†“</div>
            <div class="step check">AuthCheckScreen<br>æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨</div>
            <div class="arrow">â†“</div>
            <div class="step auth">æ£€æŸ¥ Firebase Auth currentUser</div>
            <div class="arrow">â†“</div>
        </div>
        
        <div class="branch-container">
            <div class="branch">
                <div class="branch-label">âœ… å·²ç™»å½• (currentUser != null)</div>
                <div class="arrow">â†“</div>
                <div class="step check">è¯»å– LocalDataSource<br>è·å–è§’è‰²ä¿¡æ¯</div>
                <div class="arrow">â†“</div>
                <div class="branch-container">
                    <div class="branch">
                        <div class="step senior">è€äººç«¯ä¸»é¡µ<br>SeniorHome</div>
                        <small style="text-align: center; color: #666;">role = "SENIOR"</small>
                    </div>
                    <div class="branch">
                        <div class="step caregiver">å­å¥³ç«¯ä¸»é¡µ<br>CaregiverHome</div>
                        <small style="text-align: center; color: #666;">role = "CAREGIVER"</small>
                    </div>
                </div>
            </div>
            
            <div class="branch">
                <div class="branch-label">âŒ æœªç™»å½• (currentUser == null)</div>
                <div class="arrow">â†“</div>
                <div class="step welcome">æ¬¢è¿é¡µ<br>WelcomeScreen<br>é€‰æ‹©è§’è‰²ç™»å½•</div>
            </div>
        </div>
        
        <h2>ğŸ¯ ä½¿ç”¨åœºæ™¯</h2>
        
        <div class="scenario">
            <h3>åœºæ™¯ 1: é¦–æ¬¡å®‰è£… / ç™»å‡ºå</h3>
            <div class="scenario-flow">
                App å¯åŠ¨ â†’ AuthCheck â†’ Firebase Auth (æ— ç”¨æˆ·) â†’ Welcome Screen â†’ ç”¨æˆ·é€‰æ‹©è§’è‰²ç™»å½•
            </div>
        </div>
        
        <div class="scenario">
            <h3>åœºæ™¯ 2: å·²ç™»å½•ç”¨æˆ·é‡å¯ App â­</h3>
            <div class="scenario-flow">
                App å¯åŠ¨ â†’ AuthCheck â†’ Firebase Auth (æœ‰ç”¨æˆ·) + LocalDataSource (æœ‰è§’è‰²)<br>
                â†’ ç›´æ¥è¿›å…¥å¯¹åº”ä¸»é¡µ (è€äººç«¯/å­å¥³ç«¯) ğŸš€
            </div>
        </div>
        
        <div class="scenario">
            <h3>åœºæ™¯ 3: ç”¨æˆ·ç™»å‡º</h3>
            <div class="scenario-flow">
                ç‚¹å‡»ç™»å‡º â†’ AuthRepository.logout() â†’ æ¸…é™¤ LocalDataSource â†’ Firebase Auth ç™»å‡º<br>
                â†’ å¯¼èˆªåˆ° Welcome Screen
            </div>
        </div>
        
        <div class="scenario">
            <h3>åœºæ™¯ 4: ç¼“å­˜å¼‚å¸¸ (å®‰å…¨æœºåˆ¶)</h3>
            <div class="scenario-flow">
                App å¯åŠ¨ â†’ AuthCheck â†’ Firebase Auth (æœ‰ç”¨æˆ·) + LocalDataSource (ç©º)<br>
                â†’ è¿”å› Welcome Screen â†’ ç”¨æˆ·é‡æ–°ç™»å½•
            </div>
        </div>
        
        <h2>ğŸ’» æ ¸å¿ƒä»£ç </h2>
        
        <h3>AuthCheckScreen.kt</h3>
        <div class="code-block">
<span class="keyword">@Composable</span>
<span class="keyword">fun</span> <span class="function">AuthCheckScreen</span>(
    localDataSource: LocalDataSource,
    onNavigateToSeniorHome: () -> Unit,
    onNavigateToCaregiverHome: () -> Unit,
    onNavigateToWelcome: () -> Unit
) {
    <span class="comment">// æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨</span>
    Box(modifier = Modifier.fillMaxSize()) {
        CircularProgressIndicator()
    }
    
    <span class="comment">// å¯åŠ¨æ—¶æ‰§è¡Œèº«ä»½éªŒè¯æ£€æŸ¥</span>
    <span class="function">LaunchedEffect</span>(Unit) {
        <span class="function">withContext</span>(Dispatchers.IO) {
            <span class="comment">// æ£€æŸ¥ Firebase Auth çš„ currentUser</span>
            <span class="keyword">val</span> firebaseUser = FirebaseAuth.getInstance().currentUser
            
            <span class="keyword">if</span> (firebaseUser != <span class="keyword">null</span>) {
                <span class="comment">// ç”¨æˆ·å·²ç™»å½•ï¼Œè¯»å–æœ¬åœ°ç¼“å­˜çš„è§’è‰²ä¿¡æ¯</span>
                <span class="keyword">val</span> userInfo = localDataSource.getUser()
                
                <span class="keyword">if</span> (userInfo != <span class="keyword">null</span>) {
                    <span class="keyword">val</span> (_, _, role) = userInfo
                    
                    <span class="comment">// æ ¹æ®è§’è‰²å¯¼èˆªåˆ°å¯¹åº”çš„ä¸»é¡µ</span>
                    <span class="function">withContext</span>(Dispatchers.Main) {
                        <span class="keyword">when</span> (role?.uppercase()) {
                            <span class="string">"SENIOR"</span> -> onNavigateToSeniorHome()
                            <span class="string">"CAREGIVER"</span> -> onNavigateToCaregiverHome()
                            <span class="keyword">else</span> -> onNavigateToWelcome()
                        }
                    }
                } <span class="keyword">else</span> {
                    <span class="comment">// æœ¬åœ°ç¼“å­˜ä¸ºç©ºï¼Œè¿”å›æ¬¢è¿é¡µ</span>
                    <span class="function">withContext</span>(Dispatchers.Main) {
                        onNavigateToWelcome()
                    }
                }
            } <span class="keyword">else</span> {
                <span class="comment">// ç”¨æˆ·æœªç™»å½•ï¼Œå¯¼èˆªåˆ°æ¬¢è¿é¡µ</span>
                <span class="function">withContext</span>(Dispatchers.Main) {
                    onNavigateToWelcome()
                }
            }
        }
    }
}
        </div>
        
        <h3>AppNavigation.kt (å¯åŠ¨é…ç½®)</h3>
        <div class="code-block">
<span class="keyword">@Composable</span>
<span class="keyword">fun</span> <span class="function">AppNavigation</span>(
    navController: NavHostController,
    startDestination: String = Screen.AuthCheck.route  <span class="comment">// å¯åŠ¨é¡µæ”¹ä¸º AuthCheck</span>
) {
    <span class="keyword">val</span> context = LocalContext.current
    <span class="keyword">val</span> localDataSource = LocalDataSource(context)
    
    <span class="function">NavHost</span>(
        navController = navController,
        startDestination = startDestination
    ) {
        <span class="comment">// ===== å¯åŠ¨æ—¶çš„èº«ä»½éªŒè¯æ£€æŸ¥ =====</span>
        <span class="function">composable</span>(route = Screen.AuthCheck.route) {
            <span class="function">AuthCheckScreen</span>(
                localDataSource = localDataSource,
                onNavigateToSeniorHome = {
                    navController.navigate(Screen.SeniorHome.route) {
                        <span class="comment">// æ¸…ç©ºè¿”å›æ ˆï¼Œé˜²æ­¢ç”¨æˆ·è¿”å›åˆ° AuthCheck é¡µé¢</span>
                        popUpTo(Screen.AuthCheck.route) { inclusive = <span class="keyword">true</span> }
                    }
                },
                onNavigateToCaregiverHome = {
                    navController.navigate(Screen.CaregiverHome.route) {
                        popUpTo(Screen.AuthCheck.route) { inclusive = <span class="keyword">true</span> }
                    }
                },
                onNavigateToWelcome = {
                    navController.navigate(Screen.Welcome.route) {
                        popUpTo(Screen.AuthCheck.route) { inclusive = <span class="keyword">true</span> }
                    }
                }
            )
        }
        <span class="comment">// ... å…¶ä»–é¡µé¢é…ç½®</span>
    }
}
        </div>
        
        <h2>âœ… æµ‹è¯•éªŒè¯</h2>
        <div class="scenario">
            <h3>æµ‹è¯•æ­¥éª¤:</h3>
            <ol>
                <li><strong>é¦–æ¬¡å®‰è£…æµ‹è¯•</strong>: æ¸…é™¤ App æ•°æ® â†’ å¯åŠ¨ â†’ åº”æ˜¾ç¤º Welcome Screen</li>
                <li><strong>ç™»å½•åé‡å¯æµ‹è¯•</strong>: ç™»å½•ä»»æ„è´¦å· â†’ å…³é—­ App â†’ é‡å¯ â†’ åº”ç›´æ¥è¿›å…¥ä¸»é¡µ</li>
                <li><strong>ç™»å‡ºæµ‹è¯•</strong>: å·²ç™»å½•çŠ¶æ€ â†’ ç‚¹å‡»ç™»å‡º â†’ åº”è¿”å› Welcome Screen â†’ é‡å¯ App â†’ åº”æ˜¾ç¤º Welcome Screen</li>
                <li><strong>åŒç«¯åˆ‡æ¢æµ‹è¯•</strong>: è€äººç«¯ç™»å½• â†’ é‡å¯ (è¿›è€äººç«¯) â†’ ç™»å‡º â†’ å­å¥³ç«¯ç™»å½• â†’ é‡å¯ (è¿›å­å¥³ç«¯)</li>
            </ol>
        </div>
        
        <h2>ğŸ”’ å®‰å…¨è¯´æ˜</h2>
        <ul>
            <li>âœ… LocalDataSource ä»…å­˜å‚¨è§’è‰²ä¿¡æ¯ï¼Œä¸å­˜å‚¨å¯†ç </li>
            <li>âœ… å®é™…èº«ä»½éªŒè¯ä»ä¾èµ– Firebase Auth</li>
            <li>âœ… å¦‚æœ Firebase Session è¿‡æœŸï¼Œç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•</li>
            <li>âœ… ç¼“å­˜å¼‚å¸¸æ—¶è‡ªåŠ¨è¿”å›ç™»å½•é¡µï¼Œé¿å…å®‰å…¨é£é™©</li>
        </ul>
        
        <div style="text-align: center; margin-top: 40px; padding: 20px; background: #f0f0f0; border-radius: 8px;">
            <h3 style="color: #667eea; margin-top: 0;">ğŸ‰ æ— æ„Ÿç™»å½•å®ç°å®Œæˆ!</h3>
            <p style="margin: 0; color: #666;">æ„å»ºçŠ¶æ€: <strong style="color: #43e97b;">BUILD SUCCESSFUL âœ“</strong></p>
        </div>
    </div>
</body>
</html>
